{% extends "base.html" %}

{% block title %}Historic Sales Data{% endblock %}

{% block body %}
<h2>Historic Sales Data</h2>

<!-- Active Filters & Count -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <div id="activeFilters">
        {% for col, value in filters.items() %}
            {% if value %}
                <span class="badge bg-primary me-1">
                    {{ col.replace('_',' ') }}: {{ value }}
                    <a href="#" onclick="removeFilter('{{ col }}'); return false;" class="text-white text-decoration-none ms-1">&times;</a>
                </span>
            {% endif %}
        {% endfor %}
    </div>
    <div>
        <span class="badge bg-success">Transactions: {{ filtered_count }}</span>
    </div>
</div>

<table id="historyTable" class="table table-dark table-hover table-bordered">
    <thead>
        <tr>
            {% for col, values in distinct_values.items() %}
                <th>
                    {{ col.replace('_',' ') }}

                    <!-- Asc / Desc buttons -->
                    <button onclick="applySort('{{ col }}', 'asc')" class="btn btn-sm btn-outline-light">↑</button>
                    <button onclick="applySort('{{ col }}', 'desc')" class="btn btn-sm btn-outline-light">↓</button>

                    <!-- Dropdown exact match -->
                    <select onchange="applyFilter('{{ col }}', this.value)" class="form-select form-select-sm mt-1">
                        <option value="">All</option>
                        {% for v in values %}
                            <option value="{{ v }}" {% if filters[col] == v %}selected{% endif %}>{{ v }}</option>
                        {% endfor %}
                    </select>

                    <!-- Text input filter -->
                    <input type="text" class="form-control form-control-sm mt-1"
                           placeholder="Type to filter..." onkeyup="filterColumn({{ loop.index0 }}, this.value)">
                </th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for item in items.items %}
        <tr>
            <td>{{ item.TransactionID }}</td>
            <td>{{ item.DateTime.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>{{ item.ItemName }}</td>
            <td>{{ item.QuantitySold }}</td>
            <td>{{ item.StockBeforeSale }}</td>
            <td>{{ item.StockAfterSale }}</td>
            <td>{{ item.Region }}</td>
            <td>${{ "%.2f"|format(item.UnitPrice) }}</td>
            <td>{{ 'Yes' if item.PromotionApplied else 'No' }}</td>
            <td>${{ "%.2f"|format(item.FinalPrice) }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
<div class="mt-3">
    {% if items.has_prev %}
        <a class="btn btn-outline-light btn-sm"
           href="{{ url_for('admin.history', page=items.prev_num, sort_col=request.args.get('sort_col'), sort_dir=request.args.get('sort_dir'), **filters) }}">
            Previous
        </a>
    {% endif %}
    <span class="mx-2"> Page {{ items.page }} of {{ items.pages }} </span>
    {% if items.has_next %}
        <a class="btn btn-outline-light btn-sm"
           href="{{ url_for('admin.history', page=items.next_num, sort_col=request.args.get('sort_col'), sort_dir=request.args.get('sort_dir'), **filters) }}">
            Next
        </a>
    {% endif %}
</div>

<script>
// Remove a single filter badge
function removeFilter(col) {
    const params = new URLSearchParams(window.location.search);
    params.delete(col);
    params.delete("page"); // reset pagination
    window.location.search = params.toString();
}

// Asc / Desc sort
function applySort(column, direction) {
    const params = new URLSearchParams(window.location.search);
    params.set("sort_col", column);
    params.set("sort_dir", direction);
    params.delete("page");
    window.location.search = params.toString();
}

// Dropdown exact match filter
function applyFilter(field, value) {
    const params = new URLSearchParams(window.location.search);
    if (value) params.set(field, value);
    else params.delete(field);
    params.delete("page");
    window.location.search = params.toString();
}

// Type-to-filter (client-side, case-insensitive)
function filterColumn(colIndex, filterValue) {
    const table = document.getElementById("historyTable");
    const tr = table.getElementsByTagName("tr");
    const filter = filterValue.toLowerCase();

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName("td")[colIndex];
        if (td) {
            const textValue = td.textContent || td.innerText;
            tr[i].style.display = textValue.toLowerCase().includes(filter) ? "" : "none";
        }
    }
}
</script>

{% endblock %}
