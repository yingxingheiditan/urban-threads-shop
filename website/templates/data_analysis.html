{% extends "base.html" %}

{% block title %}Data Analysis{% endblock %}

{% block body %}
<div class="container mt-4">

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label for="monthSelect" class="form-label">Month</label>
            <select id="monthSelect" class="form-select">
                {% for m in range(1, 10) %}
                    <option value="{{ m }}" {% if m == 9 %}selected{% endif %}>{{ ["January","February","March","April","May","June","July","August","September"][m-1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="yearSelect" class="form-label">Year</label>
            <select id="yearSelect" class="form-select">
                {% for y in [2023,2024,2025] %}
                    <option value="{{ y }}" {% if y == 2025 %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- KPIs Section -->
    <div class="row text-center mb-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h5>Total Items Sold</h5>
                <h2>{{ total_items }}</h2>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h5>Total Profit</h5>
                <h2>${{ "{:,.2f}".format(total_profit) }}</h2>
            </div>
        </div>
    </div>

    <hr style="border-top: 3px solid #ccc;">

    <div style="margin-bottom:6.5rem;"></div> 
    
    <!-- Charts Section -->
    <!-- Charts Section -->
    <!-- Charts Section -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card p-3">
            <h5 class="text-center mb-3">SG vs HK Sales</h5>
                <canvas id="regionPie"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
            <h5 class="text-center mb-3">Top 10 Items Sold</h5>
                <canvas id="topItemsBar"></canvas>
            </div>
        </div>
    </div>


</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // SG vs HK Pie Chart
    const regionCtx = document.getElementById('regionPie').getContext('2d');
    const regionPie = new Chart(regionCtx, {
        type: 'pie',
        data: {
            labels: {{ region_labels|tojson }},
            datasets: [{
                data: {{ region_values|tojson }},
                backgroundColor: ['#007bff','#28a745'],
            }]
        },
  options: {
        responsive: true,
        plugins: {
            tooltip: {
                enabled: true,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw;
                        const sum = context.chart._metasets[context.datasetIndex].total;
                        const percentage = ((value / sum) * 100).toFixed(1) + '%';
                        return `${label}: ${value} (${percentage})`;
                    }
                }
            }
        }
    }
});

    // Top 10 Items Horizontal Bar Chart
    const topItemsCtx = document.getElementById('topItemsBar').getContext('2d');
    const topItemsBar = new Chart(topItemsCtx, {
        type: 'bar',
        data: {
            labels: {{ top10_items_labels|tojson }},
            datasets: [{
                label: 'Quantity Sold',
                data: {{ top10_items_values|tojson }},
                backgroundColor: '#28a745'
            }]
        },
        options: {
            indexAxis: 'y', // horizontal bars
            responsive: true,
            plugins: { tooltip: { enabled: true } },
            scales: { x: { beginAtZero: true } }
        }
    });
</script>
{% endblock %}
